pipeline {
    agent any

    environment {
        GIT_REPO = 'https://github.com/Dhanush19B61A0550/splunk-terracecopilot.git'
        PYTHON_PATH = 'C:\\Users\\MTL1027\\AppData\\Local\\Programs\\Python\\Python312\\python.exe'  // Set Python Path explicitly
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: "${GIT_REPO}"
            }
        }

        stage('Check Python Version') {
            steps {
                echo 'Checking Python version...'
                bat """
                    echo Checking Python...
                    "${PYTHON_PATH}" --version || (echo Python not found! && exit 1)
                """
            }
        }

        stage('Run Terrace Copilot Analysis') {
            steps {
                echo 'Running Terrace Copilot on config files...'
                bat """
                    mkdir analysis_output
                    "${PYTHON_PATH}" jenkins\\analyze_configs.py configs\\inputs.conf > analysis_output\\inputs_suggestions.txt
                    "${PYTHON_PATH}" jenkins\\analyze_configs.py configs\\outputs.conf > analysis_output\\outputs_suggestions.txt
                """
            }
        }

        stage('Show Suggestions') {
            steps {
                echo 'Showing suggestions from Terrace Copilot'
                bat '''
                    echo Inputs.conf Suggestions:
                    type analysis_output\\inputs_suggestions.txt || echo No suggestions for inputs.conf

                    echo Outputs.conf Suggestions:
                    type analysis_output\\outputs_suggestions.txt || echo No suggestions for outputs.conf
                '''
            }
        }

        stage('Optional: Commit Suggestions') {
            when {
                expression { return fileExists('analysis_output\\inputs_suggestions.txt') }
            }
            steps {
                withCredentials([usernamePassword(credentialsId: 'github_credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                    bat '''
                        git config --global user.name "jenkins-bot"
                        git config --global user.email "jenkins@example.com"
                        git add analysis_output
                        git diff --cached --quiet || git commit -m "Add Terrace Copilot suggestions"
                        git remote set-url origin https://%GIT_USER%:%GIT_PASS%@github.com/Dhanush19B61A0550/splunk-terracecopilot.git
                        git push origin main
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution complete.'
        }
    }
}
